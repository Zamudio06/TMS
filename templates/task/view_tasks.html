<!-- templates/view_tasks.html -->
{% extends 'base.html' %}

{% block title%} View Tasks {% endblock %}

{% block content %}
<h1>Tasks</h1>

<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Email</th>
            <th>Description</th>
            <th>Expiration Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="task-list">

    </tbody>
</table>

<!-- PaginaciÃ³n -->
<nav aria-label="Page navigation">
    <ul class="pagination" id="pagination">
    </ul>
</nav>

<!-- Modal para editar tareas -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-task-form">
                    <div class="form-group">
                        <label for="edit-title">Title</label>
                        <input type="text" class="form-control" id="edit-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-email">Email</label>
                        <input type="email" class="form-control" id="edit-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-description">Description</label>
                        <textarea class="form-control" id="edit-description" name="description" required></textarea>
                    </div>
                    <input type="hidden" id="edit-task-id">
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    function loadTasks(page = 1) {
        fetch(`/api/task/?page=${page}`)
            .then(response => response.json())
            .then(data => {
                const taskList = document.getElementById('task-list');
                const pagination = document.getElementById('pagination');
                
                taskList.innerHTML = '';
                pagination.innerHTML = '';
    
                data.results.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.email}</td>
                        <td>${task.description}</td>
                        <td>${task.expiration_date}</td>
                        <td>
                            <button class="btn btn-warning edit-task" data-id="${task.id}">Edit</button>
                            <button class="btn btn-danger delete-task" data-id="${task.id}">Delete</button>
                        </td>
                    `;
                    taskList.appendChild(row);
                });
    
                const totalPages = Math.ceil(data.count / 5);
    
                for (let i = 1; i <= totalPages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                    pageItem.innerHTML = `<a class="page-link" href="#" onclick="loadTasks(${i})">${i}</a>`;
                    pagination.appendChild(pageItem);
                }
    
                document.querySelectorAll('.delete-task').forEach(button => {
                    button.addEventListener('click', function() {
                        const taskId = this.dataset.id;
                        if (confirm('Are you sure you want to delete this task?')) {
                            fetch(`/api/task/${taskId}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                }
                            })
                            .then(response => {
                                if (response.ok) {
                                    alert('Task deleted successfully!');
                                    loadTasks(page);
                                } else {
                                    alert('Failed to delete task.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                        }
                    });
                });
    
                document.querySelectorAll('.edit-task').forEach(button => {
                    button.addEventListener('click', function() {
                        const taskId = this.dataset.id;
                        fetch(`/api/task/${taskId}/`)
                            .then(response => response.json())
                            .then(task => {
                                document.getElementById('edit-title').value = task.title;
                                document.getElementById('edit-email').value = task.email;
                                document.getElementById('edit-description').value = task.description;
                                document.getElementById('edit-task-id').value = task.id;
    
                                const editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                                editModal.show();
                            });
                    });
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    

    document.getElementById('edit-task-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const taskId = document.getElementById('edit-task-id').value;
        const title = document.getElementById('edit-title').value;
        const email = document.getElementById('edit-email').value;
        const description = document.getElementById('edit-description').value;

        fetch(`/api/task/${taskId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ title, email, description })
        })
        .then(response => response.json())
        .then(data => {
            alert('Task updated successfully!');
            loadTasks();
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            editModal.hide();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    loadTasks();
</script>

{% endblock %}
